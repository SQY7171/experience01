<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…‹éš†è¯­éŸ³åŒ¹é…åº¦è¯„åˆ†</title>
    <style>
        /* é»‘ç™½è‰²ç³» Â· ç®€æ´ Â· å¿ƒç†å­¦å®éªŒè§„èŒƒ */
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        body {
            background: #f5f5f5;       /* æµ…ç°åº• */
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .experiment-container {
            max-width: 800px;
            width: 100%;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            padding: 32px 28px;
            border: 1px solid #e0e0e0;
        }
        h1 {
            font-size: 1.9rem;
            font-weight: 400;
            color: #1e1e1e;
            margin: 0 0 8px 0;
            letter-spacing: -0.01em;
            border-left: 4px solid #4a4a4a;
            padding-left: 22px;
        }
        .subhead {
            font-size: 0.95rem;
            color: #5a5a5a;
            margin: 5px 0 30px 30px;
        }
        .original-section {
            background: #f0f0f0;       /* æµ…ç°åŒºåˆ†åŒºåŸŸ */
            border-radius: 20px;
            padding: 24px 24px 20px 24px;
            margin-bottom: 36px;
            border: 1px solid #d6d6d6;
        }
        .original-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            font-size: 1.2rem;
            color: #2b2b2b;
            margin-bottom: 14px;
        }
        .original-label span {
            background: #6a6a6a;
            color: #ffffff;
            padding: 4px 14px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 400;
            letter-spacing: 0.3px;
        }
        .audio-block {
            width: 100%;
            margin: 8px 0;
        }
        audio {
            width: 100%;
            height: 48px;
            border-radius: 30px;
            outline: none;
            background: #ffffff;
            border: 1px solid #bdbdbd;
        }
        .clone-section {
            background: #ffffff;
            border-radius: 20px;
            padding: 22px 22px 28px 22px;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
        }
        .clone-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }
        .clone-title {
            font-weight: 500;
            font-size: 1.3rem;
            color: #2b2b2b;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .badge {
            background: #d8d8d8;
            color: #2e2e2e;
            padding: 5px 16px;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .progress-info {
            background: #eaeaea;
            padding: 8px 18px;
            border-radius: 40px;
            font-size: 0.9rem;
            color: #2b2b2b;
            font-weight: 500;
        }
        .clone-player {
            margin: 18px 0 22px 0;
        }
        .rating-area {
            text-align: center;
            margin: 15px 0 10px;
        }
        .rating-label {
            font-size: 1.1rem;
            color: #2b2b2b;
            margin-bottom: 12px;
            font-weight: 500;
        }
        .likert-5 {
            display: flex;
            justify-content: center;
            gap: 18px;
            flex-wrap: wrap;
            margin: 10px 0 18px;
        }
        .rating-btn {
            width: 65px;
            height: 65px;
            border-radius: 65px;
            border: 1px solid #9e9e9e;
            background: white;
            font-size: 1.9rem;
            font-weight: 400;
            color: #1e1e1e;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .rating-btn:hover:enabled {
            background: #e0e0e0;
            border-color: #6e6e6e;
            transform: scale(1.02);
        }
        .rating-btn:active:enabled {
            transform: scale(0.97);
            background: #d0d0d0;
        }
        .rating-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #f2f2f2;
            border-color: #cccccc;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .complete-message {
            background: #e0e0e0;
            border-radius: 40px;
            padding: 12px 22px;
            font-weight: 500;
            color: #1e1e1e;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #b0b0b0;
        }
        button.action-btn {
            background: #ffffff;
            border: 1px solid #9e9e9e;
            padding: 12px 28px;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 500;
            color: #2b2b2b;
            cursor: pointer;
            transition: 0.1s;
        }
        button.action-btn:hover {
            background: #eaeaea;
            border-color: #7a7a7a;
        }
        .footer-note {
            margin-top: 26px;
            font-size: 0.85rem;
            color: #777777;
            text-align: center;
            border-top: 1px dashed #bcbcbc;
            padding-top: 20px;
        }
        .warning-note {
            color: #7a4d4d;
            font-size: 0.85rem;
            background: #f0f0f0;
            border-radius: 20px;
            padding: 6px 18px;
            display: inline-block;
            border: 1px solid #c0c0c0;
        }
    </style>
</head>
<body>
    <div class="experiment-container">
        <h1>ğŸ—£ å…‹éš†è¯­éŸ³åŒ¹é…åº¦è¯„åˆ†</h1>
        <div class="subhead">æ¬¢è¿å‚åŠ æœ¬å®éªŒï¼æ‚¨çš„ä»»åŠ¡æ˜¯è¯„ä¼°å…‹éš†è¯­éŸ³ä¸åŸè¯­éŸ³çš„åŒ¹é…ç¨‹åº¦ã€‚åŸå§‹è¯­éŸ³ï¼ˆä¸Šæ–¹ç°è‰²åŒºåŸŸï¼‰å¯éšæ—¶åå¤æ’­æ”¾ï¼Œä½œä¸ºå‚è€ƒæ ‡å‡†ã€‚
            ä¸‹æ–¹å°†éšæœºå‘ˆç°32æ¡å…‹éš†è¯­éŸ³ï¼Œè¯·æ‚¨åœ¨æ¯æ¡æ’­æ”¾åæ ¹æ®å…¶ä¸åŸå§‹è¯­éŸ³çš„ç›¸ä¼¼åº¦è¿›è¡Œè¯„åˆ†ã€‚</div>
    
        <!-- åŸè¯­éŸ³åŒºåŸŸï¼šå§‹ç»ˆåœ¨æœ€å‰é¢ -->
        <div class="original-section">
            <div class="original-label">
                âš« åŸå§‹è¯­éŸ³ 
                <span>å¯åå¤æ’­æ”¾</span>
            </div>
            <div class="audio-block">
                <audio id="originalAudio" controls preload="metadata" src="audio/original.mp3">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ audio æ ‡ç­¾ã€‚
                </audio>
            </div>
            <div style="font-size:0.85rem; color:#4f4f4f; margin-top: 10px;">
                å¯¹æ¯”æ¯ä¸€æ¡å…‹éš†è¯­éŸ³ä¸åŸè¯­éŸ³çš„ç›¸ä¼¼åº¦ï¼Œç‚¹å‡»1~5è¯„åˆ†
            </div>
        </div>

        <!-- å…‹éš†è¯­éŸ³åŠ¨æ€åŒºåŸŸ -->
        <div class="clone-section">
            <div class="clone-header">
                <div class="clone-title">
                    <span>ğŸ”Š å½“å‰å…‹éš†è¯­éŸ³</span>
                    <span class="badge" id="trialCounter">1 / 32</span>
                </div>
                <div class="progress-info" id="progressDisplay">å·²å®Œæˆ: 0 / 32</div>
            </div>

            <div class="clone-player">
                <audio id="cloneAudio" controls preload="metadata" src="audio/clone1.mp3">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ audio æ ‡ç­¾ã€‚
                </audio>
            </div>

            <div class="rating-area">
                <div class="rating-label">ä¸åŸè¯­éŸ³åŒ¹é…çš„ç¨‹åº¦ï¼Ÿ</div>
                <div class="likert-5" id="ratingButtonsContainer">
                    <button class="rating-btn" data-score="1">1</button>
                    <button class="rating-btn" data-score="2">2</button>
                    <button class="rating-btn" data-score="3">3</button>
                    <button class="rating-btn" data-score="4">4</button>
                    <button class="rating-btn" data-score="5">5</button>
                </div>
                <div style="font-size:0.85rem; color:#5f5f5f; margin-top:5px;">
                    (1 = éå¸¸ä¸åŒ¹é… Â· 5 = éå¸¸åŒ¹é…)
                </div>
            </div>

            <!-- å®Œæˆ/é‡ç½®/ä¸‹è½½æ  -->
            <div class="action-bar">
                <div id="completionMessage" style="display: none;" class="complete-message">
                    âœ… æ‰€æœ‰32æ¡å·²è¯„åˆ†ï¼Œæ„Ÿè°¢æ‚¨ï¼
                </div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="action-btn" id="resetBtn">âŸ² é‡æ–°å¼€å§‹</button>
                    <button class="action-btn" id="downloadBtn">ğŸ“¥ ä¸‹è½½è¯„åˆ†ç»“æœ</button>
                </div>
            </div>
        </div>

      
    </div>

    <script>
        (function() {
            // ---------- å¯é…ç½®éŸ³é¢‘è·¯å¾„ (å®éªŒè€…ä¿®æ”¹æ­¤å¤„) ----------
            const config = {
                // åŸè¯­éŸ³æ–‡ä»¶è·¯å¾„ (ç›¸å¯¹äºindex.html)
                originalAudioSrc: 'å¤„ç†å¥½çš„ç´ ææ¨¡æ¿t2.wav',   // è¯·ç¡®ä¿æ–‡ä»¶åæ­£ç¡®
                // 32æ¡å…‹éš†è¯­éŸ³æ–‡ä»¶è·¯å¾„ (åŸå§‹é¡ºåºï¼Œç¨‹åºå°†è‡ªåŠ¨æ‰“ä¹±å‘ˆç°)
                cloneAudioSrcs: [
                    'high (1).wav', 'high (2).wav', 'high (3).wav', 'high (4).wav',
                    'high (5).wav', 'high (6).wav', 'high (7).wav', 'high (8).wav',
                    'high (9).wav', 'high (10).wav', 'high (11).wav', 'high (12).wav',
                    'high (13).wav', 'high (14).wav', 'high (15).wav', 'high (16).wav',
                    'low (1).wav', 'low (2).wav', 'low (3).wav', 'low (4).wav',
                    'low (5).wav', 'low (6).wav', 'low (7).wav', 'low (8).wav',
                    'low (9).wav', 'low (10).wav', 'low (11).wav', 'low (12).wav',   // ä¿®æ­£äº†æ‰©å±•å
                    'low (13).wav', 'low (14).wav', 'low (15).wav', 'low (16).wav'
                ]
            };

            // ---------- å›ºå®šå‚æ•° ----------
            const TOTAL_TRIALS = 32;        // 32æ¡å…‹éš†è¯­éŸ³

            // ---------- çŠ¶æ€å˜é‡ ----------
            let originalCloneSrcs = [];             // ä¿å­˜åŸå§‹é¡ºåº (æ·±æ‹·è´)
            let shuffledCloneSrcs = [];              // éšæœºé¡ºåº (ç”¨äºå‘ˆç°)
            let currentTrialIndex = 0;               // 0-31
            let ratings = new Array(TOTAL_TRIALS).fill(null);   // å­˜å‚¨æ¯æ¡è¯„åˆ† (1-5) å¯¹åº”shuffledé¡ºåº
            let experimentCompleted = false;

            // ---------- DOM å…ƒç´  ----------
            const originalAudio = document.getElementById('originalAudio');
            const cloneAudio = document.getElementById('cloneAudio');
            const trialCounterSpan = document.getElementById('trialCounter');
            const progressDisplay = document.getElementById('progressDisplay');
            const completionMessageDiv = document.getElementById('completionMessage');
            const ratingButtons = document.querySelectorAll('.rating-btn');
            const resetBtn = document.getElementById('resetBtn');
            const downloadBtn = document.getElementById('downloadBtn');

            // ---------- è¾…åŠ©å‡½æ•°ï¼šéšæœºæ‰“ä¹± (Fisher-Yates) ----------
            function shuffleArray(arr) {
                const a = [...arr];
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            }

            // ---------- é‡ç½®/åˆå§‹åŒ–é¡ºåº ----------
            function reshuffleCloneSrcs() {
                shuffledCloneSrcs = shuffleArray(originalCloneSrcs);
            }

            // ---------- è®¾ç½®åŸè¯­éŸ³ ----------
            originalAudio.src = config.originalAudioSrc;
            originalAudio.load();

            // ---------- åˆå§‹åŒ–æ•°æ® (æ·±æ‹·è´åŸå§‹æ•°ç»„) ----------
            originalCloneSrcs = [...config.cloneAudioSrcs];
            reshuffleCloneSrcs();   // éšæœºæ‰“ä¹±å‘ˆç°é¡ºåº

            // ---------- è¾…åŠ©å‡½æ•° ----------
            function refreshUI() {
                trialCounterSpan.textContent = `${currentTrialIndex + 1} / ${TOTAL_TRIALS}`;
                const ratedCount = ratings.filter(r => r !== null).length;
                progressDisplay.textContent = `å·²å®Œæˆ: ${ratedCount} / ${TOTAL_TRIALS}`;

                if (experimentCompleted) {
                    ratingButtons.forEach(btn => btn.disabled = true);
                    completionMessageDiv.style.display = 'flex';
                } else {
                    ratingButtons.forEach(btn => btn.disabled = false);
                    completionMessageDiv.style.display = 'none';
                }
            }

            // åŠ è½½æŒ‡å®šç´¢å¼•çš„å…‹éš†è¯­éŸ³ (ä»shuffledCloneSrcs)
            function loadCloneTrial(index) {
                if (index < 0 || index >= TOTAL_TRIALS) return;
                cloneAudio.src = shuffledCloneSrcs[index];   // ä½¿ç”¨éšæœºé¡ºåºçš„æ–‡ä»¶å
                cloneAudio.load();
                trialCounterSpan.textContent = `${index + 1} / ${TOTAL_TRIALS}`;
            }

            // é‡ç½®å®éªŒåˆ°åˆå§‹çŠ¶æ€ (é‡æ–°éšæœºé¡ºåºï¼Œæ¸…ç©ºè¯„åˆ†)
            function resetExperiment() {
                // é‡æ–°éšæœºæ‰“ä¹±é¡ºåº
                reshuffleCloneSrcs();
                // é‡ç½®è¯„åˆ†æ•°æ®
                ratings.fill(null);
                currentTrialIndex = 0;
                experimentCompleted = false;

                // åŠ è½½ç¬¬ä¸€ä¸ªå…‹éš†è¯­éŸ³ (æ–°çš„éšæœºé¡ºåº)
                loadCloneTrial(0);
                refreshUI();
            }

            // å¤„ç†è¯„åˆ†
            function handleRating(score) {
                if (experimentCompleted) {
                    alert('å®éªŒå·²å®Œæˆï¼Œæ— æ³•å†è¯„åˆ†ã€‚å¦‚éœ€é‡æ–°å¼€å§‹è¯·ç‚¹å‡»â€œé‡æ–°å¼€å§‹â€ã€‚');
                    return;
                }
                if (ratings[currentTrialIndex] !== null) {
                    alert('å½“å‰å…‹éš†å·²ç»è¯„è¿‡åˆ†ï¼Œä¸èƒ½é‡å¤è¯„åˆ†ã€‚');
                    return;
                }

                ratings[currentTrialIndex] = score;
                const allRated = ratings.every(r => r !== null);

                if (allRated) {
                    experimentCompleted = true;
                    refreshUI();
                    // åœç•™åœ¨å½“å‰è¯­éŸ³
                } else {
                    // å¯»æ‰¾ä¸‹ä¸€ä¸ªæœªè¯„åˆ†çš„è¯•æ¬¡
                    let nextIndex = currentTrialIndex + 1;
                    while (nextIndex < TOTAL_TRIALS && ratings[nextIndex] !== null) {
                        nextIndex++;
                    }
                    if (nextIndex < TOTAL_TRIALS) {
                        currentTrialIndex = nextIndex;
                        loadCloneTrial(currentTrialIndex);
                    } else {
                        // ç†è®ºä¸Šä¸ä¼šåˆ°è¿™é‡Œï¼Œä½†ä»¥é˜²ä¸‡ä¸€
                        for (let i = 0; i < TOTAL_TRIALS; i++) {
                            if (ratings[i] === null) {
                                currentTrialIndex = i;
                                loadCloneTrial(currentTrialIndex);
                                break;
                            }
                        }
                    }
                }
                refreshUI();
            }

            // ä¸‹è½½CSVç»“æœ (åŒ…å«æ–‡ä»¶åå’Œè¯„åˆ†ï¼Œé¡ºåºä¸ºå‘ˆç°é¡ºåº)
            function downloadRatings() {
                const ratedCount = ratings.filter(r => r !== null).length;
                if (ratedCount === 0) {
                    alert('è¿˜æ²¡æœ‰ä»»ä½•è¯„åˆ†ï¼Œè¯·å…ˆè¿›è¡Œè¯„åˆ†ã€‚');
                    return;
                }

                // ç”ŸæˆCSVå†…å®¹ï¼šæŒ‰ç…§éšæœºå‘ˆç°é¡ºåºè¾“å‡ºï¼Œæ¯ä¸€è¡ŒåŒ…å«æ–‡ä»¶åå’Œè¯„åˆ†
                let csvContent = "è¯•æ¬¡,å…‹éš†æ–‡ä»¶,è¯„åˆ†\n";  // è¡¨å¤´
                for (let i = 0; i < TOTAL_TRIALS; i++) {
                    const fileName = shuffledCloneSrcs[i].split('/').pop() || `clone${i+1}.wav`;
                    const rating = ratings[i] !== null ? ratings[i] : 'æœªè¯„åˆ†';
                    csvContent += `${i+1},${fileName},${rating}\n`;
                }

                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `è¯­éŸ³åŒ¹é…è¯„åˆ†_éšæœºé¡ºåº_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // ---------- äº‹ä»¶ç»‘å®š ----------
            ratingButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const score = parseInt(this.getAttribute('data-score'), 10);
                    handleRating(score);
                });
            });

            resetBtn.addEventListener('click', function() {
                if (confirm('ç¡®å®šé‡æ–°å¼€å§‹å®éªŒå—ï¼Ÿæ‰€æœ‰è¯„åˆ†å°†æ¸…ç©ºï¼Œä¸”è¯­éŸ³é¡ºåºå°†é‡æ–°éšæœºã€‚')) {
                    resetExperiment();
                }
            });

            downloadBtn.addEventListener('click', downloadRatings);

            // ---------- åˆå§‹åŒ–åŠ è½½ ----------
            loadCloneTrial(0);
            refreshUI();

            // ---------- éŸ³é¢‘åŠ è½½é”™è¯¯æç¤º (æ§åˆ¶å°) ----------
            cloneAudio.addEventListener('error', (e) => {
                console.warn('å…‹éš†éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„ï¼š', cloneAudio.src);
            });
            originalAudio.addEventListener('error', (e) => {
                console.warn('åŸè¯­éŸ³åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„ï¼š', originalAudio.src);
            });
        })();
    </script>
</body>
</html>
